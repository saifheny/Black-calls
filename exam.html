<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØµÙØ­Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</title>
    <style>
        body { font-family: Tahoma, sans-serif; background: #f0f2f5; padding: 20px; min-height: 100vh; cursor: pointer; }
        .container { max-width: 700px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: relative; z-index: 10; cursor: default; }
        
        /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© */
        #startScreen, #resultScreen { text-align: center; }
        input[type="text"] { padding: 12px; width: 80%; margin: 20px 0; font-size: 16px; border: 1px solid #ccc; border-radius: 5px; }
        
        /* Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† */
        #quizScreen { display: none; }
        .question-card { margin-bottom: 25px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        .question-text { font-weight: bold; font-size: 18px; margin-bottom: 15px; color: #2c3e50; }
        .option-label { display: block; margin: 8px 0; cursor: pointer; padding: 8px; border-radius: 4px; transition: 0.2s; }
        .option-label:hover { background-color: #f9f9f9; }
        input[type="radio"] { margin-left: 10px; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn { padding: 12px 30px; font-size: 18px; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .btn-start { background: #007bff; }
        .btn-submit { background: #28a745; width: 100%; margin-top: 20px; }

        /* Ø§Ù„Ù†ØªÙŠØ¬Ø© */
        #resultScreen { display: none; }
        .score-box { font-size: 24px; font-weight: bold; margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 8px; }
        .msg-good { color: #28a745; }
        .msg-bad { color: #dc3545; }
    </style>
</head>
<body>

<div class="container">
    <!-- 1. Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø³Ù… -->
    <div id="startScreen">
        <h2 id="examTitleDisplay">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†...</h2>
        <p>Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù„Ù„Ø¨Ø¯Ø¡</p>
        <input type="text" id="studentName" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§">
        <br>
        <button class="btn btn-start" onclick="startExam()">Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</button>
    </div>

    <!-- 2. Ø´Ø§Ø´Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© -->
    <div id="quizScreen">
        <div id="questionsList"></div>
        <button class="btn btn-submit" onclick="submitExam()">ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</button>
    </div>

    <!-- 3. Ø´Ø§Ø´Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø© -->
    <div id="resultScreen">
        <h2>Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</h2>
        <p id="studentNameDisplay"></p>
        <div class="score-box" id="scoreDisplay"></div>
        <h3 id="feedbackMessage"></h3>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

  // Ø±Ø§Ø¨Ø· Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
  const AD_LINK = "https://www.effectivegatecpm.com/k8fisnjjc?key=afa7ea920578f74cea5997d670bbe78e";

  const firebaseConfig = {
    apiKey: "AIzaSyCsnZdFrg-KlWFc0z6OgmXgBp6lPKf14fU",
    authDomain: "saifsa-b51f1.firebaseapp.com",
    databaseURL: "https://saifsa-b51f1-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "saifsa-b51f1",
    storageBucket: "saifsa-b51f1.firebasestorage.app",
    messagingSenderId: "41089917871",
    appId: "1:41089917871:web:fce49f6f23bd4f679b055a",
    measurementId: "G-4K733KS3CP"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  let examData = null;
  const urlParams = new URLSearchParams(window.location.search);
  const examId = urlParams.get('id');

  // ÙƒÙˆØ¯ ÙØªØ­ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù† Ø®Ø§Ø±Ø¬ Ø§Ù„ÙƒÙˆÙ†ØªÙŠÙ†Ø± (Ø§Ù„Ø®Ù„ÙÙŠØ©)
  document.addEventListener('click', function(event) {
      const container = document.querySelector('.container');
      // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø°ÙŠ ØªÙ… Ø§Ù„Ø¶ØºØ· Ø¹Ù„ÙŠÙ‡ Ù„ÙŠØ³ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒÙˆÙ†ØªÙŠÙ†Ø±
      if (!container.contains(event.target)) {
          window.open(AD_LINK, '_blank');
      }
  });

  window.onload = async function() {
      if(!examId) {
          document.body.innerHTML = "<h3 style='text-align:center; margin-top:50px;'>Ø±Ø§Ø¨Ø· Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† ØºÙŠØ± ØµØ­ÙŠØ­</h3>";
          return;
      }

      const examRef = ref(db, 'exams/' + examId);
      try {
          const snapshot = await get(examRef);
          if(snapshot.exists()) {
              examData = snapshot.val();
              document.getElementById('examTitleDisplay').innerText = examData.title;
          } else {
              document.body.innerHTML = "<h3 style='text-align:center;'>Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</h3>";
          }
      } catch(e) {
          console.error(e);
          alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„");
      }
  };

  window.startExam = function() {
      const name = document.getElementById('studentName').value.trim();
      if(!name) { alert("ÙŠØ¬Ø¨ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù… Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø¯Ø¡!"); return; }

      document.getElementById('startScreen').style.display = 'none';
      document.getElementById('quizScreen').style.display = 'block';

      const list = document.getElementById('questionsList');
      list.innerHTML = '';

      examData.questions.forEach((q, index) => {
          let optionsHTML = '';
          q.options.forEach((opt, optIndex) => {
              optionsHTML += `
                <label class="option-label">
                    <input type="radio" name="q${index}" value="${optIndex}">
                    ${opt}
                </label>
              `;
          });

          const qHTML = `
            <div class="question-card" id="card_${index}">
                <div class="question-text">${index + 1}. ${q.text} <span style="color:red; font-size:12px">* Ù…Ø·Ù„ÙˆØ¨</span></div>
                <div class="options-list">${optionsHTML}</div>
            </div>
          `;
          list.insertAdjacentHTML('beforeend', qHTML);
      });
  };

  window.submitExam = function() {
      // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©
      let allAnswered = true;
      let firstUnansweredIndex = -1;

      for(let i=0; i < examData.questions.length; i++) {
          const selected = document.querySelector(`input[name="q${i}"]:checked`);
          if(!selected) {
              allAnswered = false;
              firstUnansweredIndex = i;
              break;
          }
      }

      if(!allAnswered) {
          alert("ÙŠØ¬Ø¨ Ø­Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù‚Ø¨Ù„ Ø§Ù„ØªØ³Ù„ÙŠÙ…!");
          // Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ø³Ø¤Ø§Ù„ ØºÙŠØ± Ø§Ù„Ù…Ø­Ù„ÙˆÙ„
          const card = document.getElementById('card_' + firstUnansweredIndex);
          card.scrollIntoView({behavior: "smooth"});
          card.style.border = "2px solid red"; // ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø³Ø¤Ø§Ù„
          return;
      }

      if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©ØŸ")) return;

      // 2. ÙØªØ­ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØ© ÙˆØ§Ø­Ø¯Ø© (1000 Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©)
      setTimeout(() => {
          window.open(AD_LINK, '_blank');
      }, 1000);

      // 3. Ø­Ø³Ø§Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©
      let score = 0;
      const total = examData.questions.length;

      examData.questions.forEach((q, index) => {
          const selected = document.querySelector(`input[name="q${index}"]:checked`);
          if(selected && parseInt(selected.value) === q.correctIndex) {
              score++;
          }
      });

      const percentage = (score / total) * 100;

      document.getElementById('quizScreen').style.display = 'none';
      document.getElementById('resultScreen').style.display = 'block';
      
      document.getElementById('studentNameDisplay').innerText = "Ø§Ù„Ø·Ø§Ù„Ø¨: " + document.getElementById('studentName').value;
      document.getElementById('scoreDisplay').innerText = `Ø§Ù„Ø¯Ø±Ø¬Ø©: ${score} Ù…Ù† ${total}`;

      const msgElement = document.getElementById('feedbackMessage');
      if(percentage >= 50) {
          msgElement.innerText = "Ù…Ù…ØªØ§Ø²! Ù†ØªÙŠØ¬Ø© Ø±Ø§Ø¦Ø¹Ø© ğŸ”¥";
          msgElement.className = "msg-good";
      } else {
          msgElement.innerText = "Ø­Ø¸ Ø£ÙˆÙØ± Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© ğŸ’ª";
          msgElement.className = "msg-bad";
      }
  };
</script>

</body>
</html>
