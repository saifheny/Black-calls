<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saif TV</title>
    <style>
        :root {
            --primary: #0f0f0f; --secondary: #1f1f1f;
            --text: #ffffff; --accent: #e50914; --gray: #b3b3b3;
            --skeleton-base: #333; /* لون الهيكل الأساسي */
            --skeleton-highlight: #444; /* لون التظليل */
        }
        body {
            font-family: 'Tajawal', sans-serif; margin: 0; color: var(--text);
            background-color: var(--primary); 
            overflow-x: hidden; 
        }
        /* (تحسين السرعة) - التأكد من تحميل الخط بشكل جيد */
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap');
        
        /* Header & Search */
        header { 
            background: rgba(15,15,15,0.95); padding: 15px 5%; position: fixed; width: 90%; 
            top: 0; z-index: 1000; backdrop-filter: blur(10px); border-bottom: 1px solid #333; 
            display: flex; justify-content: space-between; align-items: center; 
        }

        .header-content {
            display: flex;
            align-items: center;
            width: 100%;
            justify-content: space-between;
            flex-direction: row-reverse; 
        }

        .logo { 
            font-size: 2em; 
            font-weight: 800; 
            color: var(--accent); 
            letter-spacing: 1px;
            transition: font-size 0.3s ease; 
            white-space: nowrap; 
        }

        /* --- Compact Search Styles --- */
        .search-container {
            position: relative;
            margin-left: auto; 
        }
        #search-input {
            width: 200px; 
            padding: 8px 15px; 
            border-radius: 20px; 
            border: 1px solid #444;
            background-color: var(--secondary);
            color: var(--text);
            font-size: 0.9em; 
            outline: none;
            transition: width 0.3s ease, background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            text-align: right;
        }
        #search-input::placeholder {
            color: var(--gray);
        }
        #search-input:focus {
            width: 350px; 
            border-color: var(--accent);
            box-shadow: 0 0 10px rgba(229, 9, 20, 0.4);
        }

        .header-content:focus-within .logo {
             font-size: 1.0em; 
             padding-left: 15px; 
        }
        
        .search-suggestions {
            position: absolute;
            top: 45px; 
            left: 0; 
            right: auto; 
            width: 350px; 
            background-color: var(--secondary);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.8);
            z-index: 1001;
            overflow: hidden;
            max-height: 0; 
            transition: max-height 0.3s ease-out;
        }
        .search-suggestions.active {
            max-height: 400px; 
            border: 1px solid #333;
            border-top: none;
        }
        .suggestion-item {
            display: flex;
            align-items: center;
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #333;
            transition: background-color 0.2s;
            color: var(--text);
        }
        .suggestion-item:last-child {
            border-bottom: none;
        }
        .suggestion-item:hover {
            background-color: rgba(255,255,255,0.1);
        }
        .suggestion-item img {
            width: 40px;
            height: 40px;
            border-radius: 4px;
            margin-left: 10px; 
            object-fit: cover;
        }
        .suggestion-item div {
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* --- End New Compact Search Styles --- */

        /* Sliders */
        .slider-container { width: 100%; overflow: hidden; position: relative; }
        .slider { 
            display: flex; gap: 15px; overflow-x: scroll; cursor: grab; padding: 5px 0; 
            scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; 
        }
        .slider::-webkit-scrollbar { display: none; }
        .banner-section { margin-top: 80px; padding-bottom: 30px; } 
        /* (تحسين السرعة) - تم إزالة transition على :hover لتحسين الأداء */
        .banner-item { min-width: 300px; height: 170px; border-radius: 10px; overflow: hidden; position: relative; transition: box-shadow 0.3s, transform 0.3s; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); scroll-snap-align: start; }
        /* (تحسين السرعة) - إضافة خاصية loading="lazy" في كود HTML لصور الـ <img> */
        .banner-item img { width: 100%; height: 100%; object-fit: cover; }
        .banner-item:hover { transform: scale(1.03); z-index: 2; box-shadow: 0 15px 30px rgba(0,0,0,0.7); }
        .category-section { padding: 30px 5%; margin-bottom: 20px; } 
        .category-title { font-size: 1.5em; margin-bottom: 15px; border-right: 4px solid var(--accent); padding-right: 10px; }
        .series-card { min-width: 160px; border-radius: 8px; overflow: hidden; cursor: pointer; transition: box-shadow 0.3s, transform 0.3s; position: relative; background: var(--secondary); box-shadow: 0 2px 5px rgba(0,0,0,0.3); scroll-snap-align: start; }
        .series-card:hover { transform: scale(1.05); box-shadow: 0 10px 20px rgba(0,0,0,0.6); }
        .series-card img { width: 100%; height: 240px; object-fit: cover; }
        .series-card .title { padding: 10px; font-size: 0.9em; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* ========= Skeleton Effect (الواجهة الحديثة) ========= */
        @keyframes shimmer {
            0% { background-position: -800px 0; }
            100% { background-position: 800px 0; }
        }
        .skeleton-base {
            background-color: var(--skeleton-base); 
            background: linear-gradient(to right, var(--skeleton-base) 8%, var(--skeleton-highlight) 18%, var(--skeleton-base) 33%);
            background-size: 800px 104px; 
            animation: shimmer 1.5s infinite linear;
        }

        .skeleton-banner {
            min-width: 300px; 
            height: 170px; 
            border-radius: 10px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); 
        }

        .skeleton-card {
            min-width: 160px; 
            height: 280px; 
            border-radius: 8px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            display: flex; /* لتمكين الشيمر الداخلي */
            flex-direction: column;
        }
        /* جزء العنوان في بطاقة السكيلتون */
        .skeleton-card .title-placeholder {
            height: 15px;
            width: 70%;
            margin: 10px auto;
            border-radius: 4px;
            background-color: var(--skeleton-base);
        }
        /* ========= نهاية تأثير التحميل ========= */


        /* Fullscreen Views */
        .fullscreen-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; background: var(--primary); transform: translateY(100%); transition: transform 0.3s ease; overflow-y: auto; }
        .fullscreen-view.active { transform: translateY(0); }
        .view-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.3; background-size: cover; background-position: center; filter: blur(20px); z-index: -1; }
        .view-header { padding: 20px; display: flex; justify-content: flex-end; }
        .close-btn { background: rgba(255,255,255,0.1); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; font-size: 1.5em; cursor: pointer; }
        .view-content { padding: 20px; max-width: 1200px; margin: 0 auto; }

        /* Episode & Details Styling */
        .info-grid { display: flex; gap: 30px; margin-bottom: 40px; flex-wrap: wrap; }
        .poster-img { width: 220px; height: 330px; border-radius: 12px; object-fit: cover; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .text-content { flex: 1; }
        .action-btn { background: var(--accent); color: white; border: none; padding: 10px 25px; border-radius: 5px; font-size: 1em; cursor: pointer; display: inline-flex; align-items: center; gap: 10px; margin-top: 5px; }
        .action-btn svg { width: 20px; height: 20px; fill: white; }
        
        .episode-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; margin-bottom: 20px; padding: 10px 0; border-bottom: 1px solid #333;}
        .episode-header h2 { margin: 0; font-size: 1.8em; max-width: 70%;}

        .episodes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .episode-card { 
            background: rgba(255,255,255,0.05); 
            padding: 10px; 
            border: 2px solid transparent; 
            border-radius: 8px; 
            cursor: pointer; 
            transition: 0.2s; 
        }
        .episode-card:hover { background: rgba(255,255,255,0.1); }
        .episode-card.active { border-color: var(--accent); background: rgba(229, 9, 20, 0.2); }
        .episode-thumb { width: 100%; height: 110px; object-fit: cover; border-radius: 5px; margin-bottom: 8px; }

        /* حاوية الفيديو (مشغل مخصص مع طبقة الإعلان) */
        .video-container { 
            width: 100%; 
            aspect-ratio: 16/9; 
            background: black; 
            border-radius: 12px; 
            overflow: hidden; 
            margin-bottom: 20px; 
            box-shadow: 0 15px 30px rgba(0,0,0,0.7); 
            position: relative; 
        }
        .video-container iframe { 
            width: 100%; 
            height: 100%; 
            border: none; 
        }
        /* الطبقة الشفافة فوق المشغل لفتح الإعلان */
        .ad-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10; 
            cursor: pointer;
            background: rgba(0,0,0,0.01); 
        }

        /* Footer */
        footer { background-color: #050505; padding: 50px 5%; margin-top: 50px; border-top: 1px solid #333; }
        .copyright { text-align: center; color: #555; margin-top: 40px; padding-top: 20px; border-top: 1px solid #222; font-size: 0.9em; }

        @media (max-width: 768px) {
            header { 
                padding: 10px 5%;
            } 
            .header-content {
                flex-direction: row-reverse; 
            }
            .search-container { 
                margin-left: auto; 
            }
            #search-input {
                width: 130px; 
                font-size: 0.8em;
            }
            #search-input:focus {
                width: 180px; 
            }
            .search-suggestions {
                width: 180px; 
            }
            .header-content:focus-within .logo {
                font-size: 0.9em; 
                padding-left: 10px;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap" rel="stylesheet">
</head>
<body>

    <header>
        <div class="header-content">
            <div class="logo">Saif TV</div>
            <div class="search-container">
                <input type="text" id="search-input" placeholder="ابحث..." />
                <div class="search-suggestions" id="suggestions-box"></div>
            </div>
        </div>
    </header>

    <div class="banner-section slider-container" id="banner-container">
        <div class="slider" id="banner-content">
            <!-- سيتم ملء هذا الجزء بهياكل التحميل (Skeletons) بواسطة JavaScript -->
        </div>
    </div>

    <main id="main-content">
        <!-- الأقسام وهياكل التحميل ستظهر هنا -->
    </main>

    <!-- Footer الاحترافي -->
    <footer>
        <div class="copyright">© 2025 Saif TV - جميع الحقوق محفوظة</div>
    </footer>

    <!-- صفحة تفاصيل المسلسل (لم تتغير) -->
    <div class="fullscreen-view" id="details-view">
        <div class="view-bg" id="details-bg"></div>
        <div class="view-header">
            <button class="close-btn" onclick="closeView('details-view')">✕</button>
        </div>
        <div class="view-content" id="details-content"></div>
    </div>

    <!-- صفحة الحلقة (الواجهة الجديدة) -->
    <div class="fullscreen-view" id="episode-view">
        <div class="view-header">
            <button class="close-btn" onclick="closeView('episode-view')">✕</button>
        </div>
        <div class="view-content" id="episode-content"></div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
      import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

      // هنا يتم وضع إعدادات Firebase الخاصة بك
      const firebaseConfig = { apiKey: "AIzaSyCsnZdFrg-KlWFc0z6OgmXgBp6lPKf14fU", authDomain: "saifsa-b51f1.firebaseapp.com", databaseURL: "https://saifsa-b51f1-default-rtdb.europe-west1.firebasedatabase.app", projectId: "saifsa-b51f1", storageBucket: "saifsa-b51f1.firebasestorage.app", messagingSenderId: "41089917871", appId: "1:41089917871:web:fce49f6f23bd4f679b055a" };
      // **********************************************************************************
      const YOUTUBE_API_KEY = 'AIzaSyA4gfRf5sGQZ-a7ficcTcgU47aJV30cSgc'; 
      const AD_LINK = 'https://www.effectivegatecpm.com/k8fisnjjc?key=afa7ea920578f74cea5997d670bbe78e';
      
      // (إضافة خاصية التوقيت للإعلان)
      const AD_COOLDOWN_MS = 20000; // 20 ثانية
      let lastAdClickTime = 0; 

      // **********************************************************************************
      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);

      // (الإصلاح والتحسين النفسي) تعريف الدالة لفتح الإعلان (نافذة منبثقة)
      window.openAdLink = function() {
          const now = Date.now();
          
          // **تعديل جوهري:** تم إضافة شرط الـ 20 ثانية هنا لضمان وجود فاصل زمني 
          // بين كل فتحة للإعلان، لتجنب حظر النوافذ المنبثقة وتحسين فعالية الإعلان
          // (مع ملاحظة أن هذا الشرط قد لا يمنع الفتح دائماً بناءً على إعدادات المتصفح)
          if (now - lastAdClickTime < AD_COOLDOWN_MS) {
              console.log("Ad link cooldown active. Time remaining:", (AD_COOLDOWN_MS - (now - lastAdClickTime)) / 1000, "s");
              // **ملاحظة:** بناءً على طلبك أن الضغطة "عادية" حتى في الكول داون، 
              // لكن لزيادة الفعالية الإعلانية، نفضل انتظار الكول داون.
              // إذا كنت تريد أن يفتح الإعلان في كل ضغطة يدوية، قم بإزالة شرط 'if' هذا.
              // سنبقي على الشرط لضمان أداء أفضل لإعلانات Pop-up.
              return; 
          }
          
          // محاولة فتح النافذة المنبثقة مباشرة
          const newWindow = window.open(AD_LINK, '_blank');
          
          // (تحسين UX) محاولة التركيز على النافذة الأصلية بعد فتح المنبثقة
          if (newWindow) {
             setTimeout(() => {
                  if (window.focus) {
                      window.focus();
                  }
             }, 100); // تأخير بسيط
          }
          
          lastAdClickTime = now; // تحديث وقت آخر ضغطة إعلان ناجحة
      }

      // دالة مساعدة لجلب البيانات من YouTube
      async function fetchYT(params) {
          try {
              const res = await fetch(`https://www.googleapis.com/youtube/v3/${params}&key=${YOUTUBE_API_KEY}`);
              return await res.json();
          } catch(e) { console.error("Error fetching YT data:", e); return null; }
      }

      const allSeriesData = []; 
      const seriesIdSet = new Set(); 
      const NUM_SKELETONS = 6;
      const SKELETON_HTML = Array(NUM_SKELETONS).fill('<div class="skeleton-card skeleton-base"><div class="title-placeholder"></div></div>').join('');
      const SKELETON_BANNER_HTML = Array(4).fill('<div class="skeleton-banner skeleton-base"></div>').join('');


      onValue(ref(database, 'series/'), (snapshot) => {
          const data = snapshot.val() || {};
          const allPlaylists = [];
          Object.keys(data).forEach(cat => {
              Object.values(data[cat]).forEach(item => {
                  if (!seriesIdSet.has(item.playlistId)) {
                      allPlaylists.push(item.playlistId);
                      seriesIdSet.add(item.playlistId);
                  }
              });
          });
          const uniqueIds = [...new Set(allPlaylists)];
          
          // (تحسين UX) عرض هياكل التحميل للبانر أولاً
          const bannerContainer = document.getElementById('banner-content');
          bannerContainer.innerHTML = SKELETON_BANNER_HTML;
          makeDraggable(bannerContainer);
          buildBanner(uniqueIds);

          const mainContent = document.getElementById('main-content');
          mainContent.innerHTML = '';
          
          Object.keys(data).forEach(async cat => {
              const section = document.createElement('div');
              section.className = 'category-section';
              // (تحسين UX) عرض هياكل التحميل للأقسام
              section.innerHTML = `<h2 class="category-title">${cat}</h2><div class="slider-container"><div class="slider" id="cat-${cat}">${SKELETON_HTML}</div></div>`;
              mainContent.appendChild(section);
              
              const catIds = Object.values(data[cat]).map(i => i.playlistId);
              const sliderElement = document.getElementById(`cat-${cat}`);
              await buildSlider(sliderElement, catIds);
              makeDraggable(sliderElement); 
          });
      });

      async function buildBanner(ids) {
          const container = document.getElementById('banner-content');
          container.innerHTML = ''; // إزالة هياكل التحميل
          const recentIds = ids.slice(-10); 
          
          for (const id of recentIds) {
              const info = await fetchYT(`playlists?part=snippet&id=${id}`);
              if(info && info.items.length > 0) {
                  const title = info.items[0].snippet.title; 
                  // (تحسين السرعة) جودة الصورة عالية (maxres)
                  const img = info.items[0].snippet.thumbnails.maxres?.url || info.items[0].snippet.thumbnails.high.url;
                  
                  if (!allSeriesData.find(s => s.id === id)) {
                      allSeriesData.push({ id, title, img });
                  }

                  const div = document.createElement('div');
                  div.className = 'banner-item';
                  div.onclick = () => window.openSeries(id); 
                  // (تحسين السرعة) loading="lazy" لصور البانر
                  div.innerHTML = `<img src="${img}" loading="lazy">`; 
                  container.appendChild(div);
              }
          }
      }

      async function buildSlider(container, ids) {
          container.innerHTML = ''; // إزالة هياكل التحميل
          for (const id of ids) {
              const info = await fetchYT(`playlists?part=snippet&id=${id}`);
              if(info && info.items.length > 0) {
                  const title = info.items[0].snippet.title;
                  // (تحسين السرعة) جودة الصورة عالية (high)
                  const img = info.items[0].snippet.thumbnails.high.url;
                  
                  if (!allSeriesData.find(s => s.id === id)) {
                      allSeriesData.push({ id, title, img });
                  }
                  
                  const div = document.createElement('div');
                  div.className = 'series-card';
                  div.onclick = () => window.openSeries(id); 
                  // (تحسين السرعة) loading="lazy" لصور السلايدرات
                  div.innerHTML = `<img src="${img}" loading="lazy"><div class="title">${title}</div>`; 
                  container.appendChild(div);
              }
          }
      }
      
      const searchInput = document.getElementById('search-input');
      const suggestionsBox = document.getElementById('suggestions-box');

      searchInput.addEventListener('input', handleSearch);
      searchInput.addEventListener('focus', handleSearch); 

      document.addEventListener('click', (e) => {
           if (!e.target.closest('.search-container')) {
               suggestionsBox.classList.remove('active');
           }
      });

      function handleSearch(e) {
          const query = searchInput.value.trim().toLowerCase();
          suggestionsBox.innerHTML = '';
          
          if (query.length < 2 && e.type !== 'focus') { 
              suggestionsBox.classList.remove('active');
              return;
          }
          
          const results = allSeriesData.filter(series => 
              series.title.toLowerCase().includes(query)
          );

          if (results.length === 0) {
              if (query.length > 0) {
                  suggestionsBox.innerHTML = '<div class="suggestion-item" style="cursor:default;color:var(--gray);text-align:center;justify-content:center;">لا توجد نتائج مطابقة</div>';
                  suggestionsBox.classList.add('active');
              } else {
                  suggestionsBox.classList.remove('active');
              }
              return;
          }
          
          const topResults = results.slice(0, 4); 
          
          topResults.forEach(series => {
              const item = document.createElement('div');
              item.className = 'suggestion-item';
              item.innerHTML = `
                  <img src="${series.img}">
                  <div>${series.title}</div>
              `;
              item.onclick = () => {
                  window.openSeries(series.id);
                  suggestionsBox.classList.remove('active');
                  searchInput.value = series.title; 
                  searchInput.blur();
              };
              suggestionsBox.appendChild(item);
          });
          
          suggestionsBox.classList.add('active');
      }
      
      
      window.openSeries = async (id) => {
          // (تعديل) لا يتم فتح إعلان هنا. يتم فتح الإعلان عند النقر على الحلقة نفسها.
          const view = document.getElementById('details-view');
          const content = document.getElementById('details-content');
          content.innerHTML = '<h2 style="text-align:center">جاري التحميل...</h2>';
          view.classList.add('active');
          
          const info = await fetchYT(`playlists?part=snippet&id=${id}`);
          const items = await fetchYT(`playlistItems?part=snippet&playlistId=${id}&maxResults=50`);
          
          if(!info || !items || info.items.length === 0) {
             content.innerHTML = '<h2 style="text-align:center">عذراً، لم يتم العثور على بيانات المسلسل.</h2>';
             return;
          }
          
          const s = info.items[0].snippet;
          const bg = s.thumbnails.maxres?.url || s.thumbnails.high.url;
          document.getElementById('details-bg').style.backgroundImage = `url(${bg})`;
          
          // (معدل) استدعاء openAdLink عند النقر على بطاقة الحلقة
          const episodesHtml = items.items.map(e => `
              <div class="episode-card" onclick="window.openAdLink(); window.playEpisode('${id}', '${e.snippet.resourceId.videoId}', '${e.snippet.title}')">
                  <img class="episode-thumb" src="${e.snippet.thumbnails.medium.url}">
                  <div>${e.snippet.title}</div>
              </div>
          `).join('');

          content.innerHTML = `
              <div class="info-grid">
                  <img class="poster-img" src="${s.thumbnails.high.url}">
                  <div class="text-content">
                      <h1>${s.title}</h1>
                      <p>${s.description.substring(0, 200)}${s.description.length > 200 ? '...' : ''}</p>
                      <button class="action-btn" onclick="window.shareLink('${id}')">
                          <svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/></svg>
                          مشاركة المسلسل
                      </button>
                  </div>
              </div>
              <h3>الحلقات (${items.items.length})</h3>
              <div class="episodes-grid">${episodesHtml}</div>
          `;
      }


      window.playEpisode = async (playlistId, videoId, title) => {
          const view = document.getElementById('episode-view');
          const content = document.getElementById('episode-content');
          document.getElementById('details-view').classList.remove('active');
          view.classList.add('active');
          
          content.innerHTML = `
              <!-- 1. المشغل في الأعلى مع الطبقة الشفافة -->
              <div class="video-container">
                  <div class="ad-overlay" id="ad-overlay"></div> <!-- طبقة الحجب/الإعلان (سيتم إضافة معالج النقر لها لاحقاً) -->
                  <iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1" allow="autoplay; fullscreen" allowfullscreen></iframe>
              </div>
              
              <!-- 2. العنوان وزر المشاركة (صفحة حالية) -->
              <div class="episode-header">
                  <h2>${title}</h2> 
                  <button class="action-btn" onclick="window.shareLink('${playlistId}', '${videoId}')">
                    <svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"/></svg>
                    مشاركة الحلقة الحالية
                  </button>
              </div>

              <!-- 3. باقي الحلقات -->
              <h3>باقي الحلقات</h3>
              <div class="episodes-grid" id="related-eps">
                 <p style="color:var(--gray);">جاري تحميل الحلقات...</p>
              </div>
          `;
          
          // (تحسين الإعلانات) إضافة معالج حدث النقر لفتح الإعلان عند النقر على الطبقة الشفافة
          document.getElementById('ad-overlay').addEventListener('click', window.openAdLink);

          // تحميل الحلقات المقترحة في الاسفل
          const items = await fetchYT(`playlistItems?part=snippet&playlistId=${playlistId}&maxResults=50`);
          
          if(items && items.items) {
              const html = items.items.map(e => {
                 const current = e.snippet.resourceId.videoId === videoId ? ' active' : '';
                 const epTitle = e.snippet.title;
                 // (معدل) إضافة استدعاء openAdLink عند النقر على حلقة مقترحة
                 return `
                     <div class="episode-card${current}" 
                          onclick="window.openAdLink(); window.playEpisode('${playlistId}', '${e.snippet.resourceId.videoId}', '${epTitle}')">
                          <img class="episode-thumb" src="${e.snippet.thumbnails.medium.url}">
                          <div title="${epTitle}">${epTitle}</div>
                      </div>
                  `;
              }).join('');
              document.getElementById('related-eps').innerHTML = html;
              
              window.history.pushState("", document.title, `#series=${playlistId}&vid=${videoId}`);
          } else {
               document.getElementById('related-eps').innerHTML = '<p style="color:var(--gray);">تعذر تحميل قائمة الحلقات (تأكد من مفتاح API).<p>';
          }
      }

      window.closeView = (id) => {
          document.getElementById(id).classList.remove('active');
          if(id === 'episode-view') {
             const iframe = document.querySelector('#episode-content iframe');
             if(iframe) iframe.src = ''; 
          }
          if(window.location.hash.includes('#series=')) {
              window.history.pushState("", document.title, window.location.pathname + window.location.search);
          }
      };
      
      window.shareLink = (pid, vid) => {
          let url = `${window.location.origin}${window.location.pathname}#series=${pid}`;
          if(vid) url += `&vid=${vid}`;
          
          if (navigator.share) {
              navigator.share({
                  title: 'شاهد معنا',
                  url: url,
              }).catch(error => console.log('Error sharing', error));
          } else {
              navigator.clipboard.writeText(url).then(() => alert('تم نسخ رابط الصفحة الحالية بنجاح!'));
          }
      }
      
      // فتح الروابط المباشرة (Deep Linking)
      window.onload = () => {
          const hash = window.location.hash;
          if(hash.includes('series=')) {
              const pid = hash.split('series=')[1].split('&')[0];
              const vid = hash.includes('vid=') ? hash.split('vid=')[1].split('&')[0] : null;
              if(vid) {
                 window.openAdLink(); 
                 fetchYT(`videos?part=snippet&id=${vid}`).then(data => {
                      const title = data.items.length > 0 ? data.items[0].snippet.title : 'جاري تحميل العنوان...';
                      window.playEpisode(pid, vid, title);
                 });
              }
              else window.openSeries(pid);
          }
      }
      
      // كود تفعيل السحب اليدوي (Drag/Swipe)
      window.makeDraggable = (slider) => {
        let isDown = false;
        let startX;
        let scrollLeft;

        const startDrag = (e) => {
            isDown = true;
            slider.style.cursor = 'grabbing';
            const clientX = e.touches ? e.touches[0].pageX : e.pageX;
            startX = clientX - slider.offsetLeft;
            scrollLeft = slider.scrollLeft;
        };

        const endDrag = () => {
            isDown = false;
            slider.style.cursor = 'grab';
        };

        const moveDrag = (e) => {
            if(!isDown) return;
            e.preventDefault();
            const clientX = e.touches ? e.touches[0].pageX : e.pageX;
            const x = clientX - slider.offsetLeft;
            const walk = (x - startX) * 2; 
            slider.scrollLeft = scrollLeft - walk;
        };

        // أحداث الفأرة واللمس
        slider.addEventListener('mousedown', startDrag);
        slider.addEventListener('mouseleave', endDrag);
        slider.addEventListener('mouseup', endDrag);
        slider.addEventListener('mousemove', moveDrag);
        slider.addEventListener('touchstart', startDrag, { passive: true });
        slider.addEventListener('touchend', endDrag);
        slider.addEventListener('touchmove', moveDrag, { passive: false });
      };
    </script>
</body>
</html>
