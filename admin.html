<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم المعلم - إنشاء امتحان</title>
    <style>
        body { font-family: Tahoma, sans-serif; background: #f4f4f9; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; }
        .input-group { margin-bottom: 15px; }
        input[type="text"] { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .question-block { background: #eef; padding: 15px; margin-bottom: 15px; border-radius: 5px; border: 1px solid #ccd; }
        .option-row { display: flex; align-items: center; gap: 10px; }
        button { padding: 10px 20px; cursor: pointer; border: none; border-radius: 4px; font-size: 16px; }
        .btn-add { background: #28a745; color: white; }
        .btn-save { background: #007bff; color: white; width: 100%; margin-top: 20px; }
        #examLinkArea { margin-top: 20px; padding: 15px; background: #d4edda; border: 1px solid #c3e6cb; color: #155724; display: none; text-align: center; }
        a { font-weight: bold; color: #155724; word-break: break-all; } /* تم إضافة word-break هنا */
    </style>
</head>
<body>

<div class="container">
    <h2>إنشاء امتحان جديد</h2>
    <div class="input-group">
        <label>عنوان الامتحان:</label>
        <input type="text" id="examTitle" placeholder="مثال: اختبار التاريخ الشهري">
    </div>

    <div id="questionsContainer">
        </div>

    <button class="btn-add" onclick="addQuestion()">+ أضف سؤال</button>
    <button class="btn-save" onclick="saveExam()">حفظ الامتحان وإنشاء الرابط</button>

    <div id="examLinkArea">
        <p>تم إنشاء الامتحان بنجاح! انسخ الرابط وشاركه مع الطلاب:</p>
        <a href="#" id="generatedLink" target="_blank">رابط الامتحان</a>
    </div>
</div>

<script type="module">
  // استيراد دوال فايربيس
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { getDatabase, ref, push, set } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCsnZdFrg-KlWFc0z6OgmXgBp6lPKf14fU",
    authDomain: "saifsa-b51f1.firebaseapp.com",
    databaseURL: "https://saifsa-b51f1-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "saifsa-b51f1",
    storageBucket: "saifsa-b51f1.firebasestorage.app",
    messagingSenderId: "41089917871",
    appId: "1:41089917871:web:fce49f6f23bd4f679b055a",
    measurementId: "G-4K733KS3CP"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // جعل الدوال متاحة في النطاق العام لاستخدامها في HTML
  window.addQuestion = function() {
      const container = document.getElementById('questionsContainer');
      const qIndex = container.children.length;
      
      const html = `
        <div class="question-block" id="q_${qIndex}">
            <input type="text" class="q-text" placeholder="نص السؤال رقم ${qIndex + 1}">
            <div class="options">
                <p style="font-size:12px; color:red">* اختر الدائرة بجوار الإجابة الصحيحة</p>
                ${[0, 1, 2, 3].map(i => `
                    <div class="option-row">
                        <input type="radio" name="correct_${qIndex}" value="${i}">
                        <input type="text" class="opt-text" placeholder="الاختيار ${i + 1}">
                    </div>
                `).join('')}
            </div>
        </div>
      `;
      container.insertAdjacentHTML('beforeend', html);
  }

  window.saveExam = function() {
      const title = document.getElementById('examTitle').value;
      if(!title) { alert("يرجى كتابة عنوان الامتحان"); return; }

      const qBlocks = document.querySelectorAll('.question-block');
      if(qBlocks.length === 0) { alert("أضف سؤالاً واحداً على الأقل"); return; }

      let questionsData = [];
      
      for (let block of qBlocks) {
          const qText = block.querySelector('.q-text').value;
          const optInputs = block.querySelectorAll('.opt-text');
          const correctRadio = block.querySelector('input[type="radio"]:checked');

          if(!qText || !correctRadio) {
              alert("تأكد من كتابة نص جميع الأسئلة واختيار الإجابة الصحيحة لكل سؤال");
              return;
          }

          let options = [];
          optInputs.forEach(inp => options.push(inp.value));

          questionsData.push({
              text: qText,
              options: options,
              correctIndex: parseInt(correctRadio.value)
          });
      }

      // حفظ في فايربيس
      const examsRef = ref(db, 'exams');
      const newExamRef = push(examsRef);
      
      set(newExamRef, {
          title: title,
          questions: questionsData,
          createdAt: Date.now()
      }).then(() => {
          const examId = newExamRef.key;
          // تم تعديل الرابط لاستخدام window.location.origin للحصول على النطاق الأساسي
          const link = ${window.location.origin}/free/exam.html?id=${examId};
          
          document.getElementById('generatedLink').href = link;
          document.getElementById('generatedLink').innerText = link;
          document.getElementById('examLinkArea').style.display = 'block';
          alert("تم الحفظ بنجاح!");
      }).catch((error) => {
          alert("حدث خطأ: " + error.message);
      });
  }

  // إضافة سؤال واحد افتراضي عند التحميل
  window.onload = addQuestion;
</script>

</body>
</html>
