const fetch = require('node-fetch');

// ğŸ”´ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø³Ø±ÙŠ Ø³ÙŠØªÙ… Ù‚Ø±Ø§Ø¡ØªÙ‡ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Vercel (Ù„Ø§ ØªØ¶Ø¹Ù‡ Ù‡Ù†Ø§)
const GEMINI_API_KEY = process.env.GEMINI_API_KEY; 
const GEMINI_ENDPOINT = https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY};

module.exports = async (req, res) => {
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª CORS (Ù…Ù‡Ù…Ø© Ù„Ù„Ø§ØªØµØ§Ù„ Ù…Ù† index.html)
    res.setHeader('Access-Control-Allow-Origin', '*'); 
    res.setHeader('Access-Control-Allow-Methods', 'POST, OPTIONS');
    res.setHeader('Access-Control-Allow-Headers', 'Content-Type');

    if (req.method === 'OPTIONS') {
        return res.status(200).send();
    }
    
    // Ø§Ù„Ø£Ù…Ø§Ù†
    if (!GEMINI_API_KEY) {
        return res.status(500).json({ error: 'Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø³Ø±ÙŠ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¹Ø¯Ø§Ø¯Ù‡ ÙÙŠ Vercel.' });
    }

    try {
        const userPrompt = req.body.idea;

        const requestBody = {
            "contents": [{
                "parts": [{
                    "text": Ø§ÙƒØªØ¨ Ù„ÙŠ Ù‚ØµØ© Ù‚ØµÙŠØ±Ø© (3 Ø£Ùˆ 4 Ø£Ø³Ø·Ø±) Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ÙÙƒØ±Ø©: "${userPrompt}"
                }]
            }]
        };

        const apiResponse = await fetch(GEMINI_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestBody)
        });

        const data = await apiResponse.json();
        const storyText = data.candidates[0].content.parts[0].text;
        
        res.status(200).json({ storyText: storyText });

    } catch (error) {
        console.error("API Error:", error);
        res.status(500).json({ error: 'ÙØ´Ù„ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù‚ØµØ©.' });
    }
};
